-- Tests for Hbase - Load/Extract
-- Added April 2014
--
-- @@@ START COPYRIGHT @@@
--
-- (C) Copyright 2014 Hewlett-Packard Development Company, L.P.
--
--  Licensed under the Apache License, Version 2.0 (the "License");
--  you may not use this file except in compliance with the License.
--  You may obtain a copy of the License at
--
--      http://www.apache.org/licenses/LICENSE-2.0
--
--  Unless required by applicable law or agreed to in writing, software
--  distributed under the License is distributed on an "AS IS" BASIS,
--  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
--  See the License for the specific language governing permissions and
--  limitations under the License.
--
-- @@@ END COPYRIGHT @@@

set schema trafodion.hbase;

prepare indexInfo from
select left(o1.object_name,20),o1.object_type  , o1.valid_def Index_valid_def, o2.valid_def     table_valid_def
from trafodion."_MD_".objects o1 
join  trafodion."_MD_".indexes i on  o1.object_uid=i.index_uid
join   trafodion."_MD_".objects o2 on i.base_table_uid=o2.object_uid
where o1.object_type='IX' and o2.Object_Name=? and o2.schema_name='HBASE' and O2.catalog_name='TRAFODION';


cqd comp_bool_226 'on';

obey TEST017(clnup);
log LOG017 clear;
obey TEST017(setup);

obey TEST017(tests_simple);

--obey TEST017(clnup);
log;
exit;

?section clnup
--------------
drop index T017TTBIDXb;
drop  index T017TTBIDXc;
drop  index T017TTCIDXb;
drop  index T017TTCIDXc;
drop table T017TTB ;
drop table T017TTA ;
drop table T017TTC ;



?section setup
--------------
create  table T017TTB ( a int not null primary key, b int, c int);

create  table T017TTA ( a int not null primary key, b int, c int);

create  table T017TTC ( a int not null primary key, b int, c int) SALT using 2 partitions on (a);

load  into T017TTA
  select
    0 +  (100 * x100) +  (10 * x10) + x1,
    0 +  (100 * x100) +  (10 * x10) + x1,
    0 +  (100 * x100) +  (10 * x10) + x1
  from (values(1)) as starter
    transpose 0,1,2,3,4,5,6,7,8,9 as x100
    transpose 0,1,2,3,4,5,6,7,8,9 as x10
    transpose 0,1,2,3,4,5,6,7,8,9 as x1 ;

?section  tests_simple
----------------------
create index T017TTBIDXb on T017TTB(b) no populate;
create index T017TTBIDXc on T017TTB(c) no populate;

create index T017TTCIDXb on T017TTC(b) no populate;
create index T017TTCIDXc on T017TTC(c) no populate;


execute indexinfo using 'T017TTB';
execute indexinfo using 'T017TTC';
set parserflags 1;
select count(*) from table(index_table T017TTBIDXb);
select count(*) from table(index_table T017TTBIDXc);
select count(*) from table(index_table T017TTCIDXb);
select count(*) from table(index_table T017TTCIDXc);

alter table T017TTB enable all indexes;
alter table T017TTC enable all indexes;

execute indexinfo using 'T017TTB';
execute indexinfo using 'T017TTC';

alter table T017TTB disable all indexes;
alter table T017TTC disable all indexes;

execute indexinfo using 'T017TTB';
execute indexinfo using 'T017TTC';
load into T017TTB select * from T017TTA;
load into T017TTC select * from T017TTA;


populate all indexes on T017TTB;
execute indexinfo using 'T017TTB';
set parserflags 1;
select count(*) from table(index_table T017TTBIDXb);
select count(*) from table(index_table T017TTBIDXc);

populate all indexes on T017TTC;
execute indexinfo using 'T017TTC';
set parserflags 1;
select count(*) from table(index_table T017TTCIDXb);
select count(*) from table(index_table T017TTCIDXc);

drop index T017TTBIDXb;
drop index T017TTBIDXc;

populate all indexes on T017TTB;
alter table T017TTB enable all indexes;


