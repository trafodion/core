>>sh rm -f LOG135-SECONDARY;
>>obey TEST135(set_up);
>>
>>-- create schema
>>create schema t135sch;

--- SQL operation complete.
>>
>>-- Prepare library file
>>sh rm -f ./udrtest135.dll;
>>sh sh $$scriptsdir$$/tools/dll-compile.ksh udrtest135.c
+>  2>&1 | tee LOG135-SECONDARY;
>>set pattern $$DLL$$ udrtest135.dll;
>>
>>-- enable authorization;
>>initialize authorization;

--- SQL operation complete.
>>get tables in schema privmgr_md;

Tables in Schema TRAFODION.PRIVMGR_MD
=====================================

COMPONENTS
COMPONENT_OPERATIONS
COMPONENT_PRIVILEGES
OBJECT_PRIVILEGES
ROLE_USAGE

--- SQL operation complete.
>>
>>-- Prepare metadata queries
>>prepare check_privs from 
+>select object_name, grantee_name, grantor_name 
+>from privmgr_md.object_privileges
+>where 
+>  object_name in ('TRAFODION.T135SCH.T135_T1', 'TRAFODION.T135SCH.T135_T2', 'TRAFODION.T135SCH.T135_V1', 'TRAFODION.T135SCH.T135_V2', 'TRAFODION.T135SCH.T135_L1', 'TRAFODION.T135SCH.T135_L2', 'TRAFODION.T135SCH.T135_SESSIONIZE', 'TRAFODION.T135SCH.T135_ADD2')
+>for read uncommitted access;

--- SQL command prepared.
>>
>>obey TEST135(tbl_tests);
>>set schema t135sch;

--- SQL operation complete.
>>
>>-- Verify that a create table adds privilege manager metadata
>>create table t135_t1 (c1 int not null primary key, c2 int);

--- SQL operation complete.
>>-- returns 1 row
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_T1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 1 row(s) selected.
>>
>>-- Verify that a drop table removes privilege manager metadata
>>drop table t135_t1;

--- SQL operation complete.
>>-- returns 0 rows
>>execute check_privs;

--- 0 row(s) selected.
>>
>>-- Verify metadata for tables and indexes
>>create table t135_t1 (c1 int not null primary key, c2 int);

--- SQL operation complete.
>>create index ndx1 on t135_t1(c2);

--- SQL operation complete.
>>-- returns 1 row
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_T1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 1 row(s) selected.
>>
>>drop table t135_t1;

--- SQL operation complete.
>>-- returns 0 rows
>>execute check_privs;

--- 0 row(s) selected.
>>
>>-- Verify metadata for tables, indexes, and views
>>create table t135_t1 (c1 int not null primary key, c2 int);

--- SQL operation complete.
>>create index ndx1 on t135_t1(c2);

--- SQL operation complete.
>>create view t135_v1 as select * from t135_t1;

--- SQL operation complete.
>>create view t135_v2 as select * from t135_t1;

--- SQL operation complete.
>>-- returns 3 rows
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_T1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_V1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_V2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 3 row(s) selected.
>>
>>-- fails
>>drop table t135_t1;

*** ERROR[1047] Request failed.  Dependent view TRAFODION.T135SCH.T135_V1 exists.

--- SQL operation failed with errors.
>>-- returns 3 rows
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_T1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_V1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_V2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 3 row(s) selected.
>>
>>drop table t135_t1 cascade;

--- SQL operation complete.
>>-- returns 0 rows
>>execute check_privs;

--- 0 row(s) selected.
>>
>>-- verify views referencing multiple tables and create table like
>>create table t135_t1 (c1 int not null primary key, c2 int);

--- SQL operation complete.
>>create table t135_t2 like t135_t1;

--- SQL operation complete.
>>create view t135_v1 as select t135_t1.c1, t135_t2.c2 from t135_t1, t135_t2
+>   where t135_t1.c1 = t135_t2.c1;

--- SQL operation complete.
>>-- return 3 rows
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_T1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_V1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_T2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 3 row(s) selected.
>>
>>drop view t135_v1;

--- SQL operation complete.
>>-- return 2 rows
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_T1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_T2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 2 row(s) selected.
>>drop table t135_t1;

--- SQL operation complete.
>>-- return 1 rows
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_T2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 1 row(s) selected.
>>drop table t135_t2;

--- SQL operation complete.
>>-- return 0 rows
>>execute check_privs;

--- 0 row(s) selected.
>>
>>obey TEST135(udr_tests);
>>set schema t135sch;

--- SQL operation complete.
>>
>>-- Verify metadata for libraries 
>>create library t135_l1 file 'udrtest135.dll';

--- SQL operation complete.
>>-- return 1 row
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_L1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 1 row(s) selected.
>>drop library t135_l1;

--- SQL operation complete.
>>-- return 0 rows
>>execute check_privs;

--- 0 row(s) selected.
>>
>>-- verify metadata for table mapping functions
>>create library t135_l1 file 'udrtest135.dll';

--- SQL operation complete.
>>create table_mapping function t135_sessionize(colname char(10), timeintval int)
+>returns (userid char(32), ts largeint, session_id largeint)
+>external name 'SESSIONIZE'
+>library t135_l1;

--- SQL operation complete.
>>-- return 2 rows
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_L1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_SESSIONIZE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 2 row(s) selected.
>>
>>-- verify metadata for functions
>>create function t135_ADD2(int,int) returns (ADD2 int)
+>language c parameter style sql external name 'add2'
+>library t135_l1
+>deterministic no sql final call allow any parallelism state area size 1024 ;

--- SQL operation complete.
>>-- return 3 rows
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_L1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_SESSIONIZE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_ADD2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 3 row(s) selected.
>>
>>drop function t135_add2;

--- SQL operation complete.
>>-- return 2 rows
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_L1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         
TRAFODION.T135SCH.T135_SESSIONIZE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 2 row(s) selected.
>>
>>drop table_mapping function t135_sessionize;

--- SQL operation complete.
>>-- return 1 row
>>execute check_privs;

OBJECT_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               GRANTEE_NAME                                                                                                                                                                                                                                                      GRANTOR_NAME
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

TRAFODION.T135SCH.T135_L1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DB__ROOT                                                                                                                                                                                                                                                          _SYSTEM                                                                                                                                                                                                                                                         

--- 1 row(s) selected.
>>
>>drop library t135_l1;

--- SQL operation complete.
>>-- return 0 rows
>>execute check_privs;

--- 0 row(s) selected.
>>
>>obey TEST135(negative_tests);
>>set schema t135sch;

--- SQL operation complete.
>>--initialize authorization, drop;
>>
>>
>>log;
